---
title: 'Calculation of total daily precipitation using ASOS data: Example'
author: "Robert McDonald"
date: "July 1, 2017"
output:
  github_document: default
  html_document:
    keep_md: yes
  pdf_document: default
---

```{r setup, include=FALSE, message=FALSE}
library(knitr)
library(XML)
library(tidyverse)
library(lubridate)
library(magrittr)
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA, 
                      results='asis', 
                      message=FALSE,
                      warning=FALSE)
```


## Introduction

The purpose of this document is to illustrate the computation of 
daily precipitation totals using Automated Surface Observation 
System (ASOS) [data from Iowa 
State](https://mesonet.agron.iastate.edu/ASOS/). (This data is the 
source for the `weather` dataframe in the `nycflights13` R package.)

You should be aware that the concept of a "daily precipitation total"
is fraught. If you are interested, there is
a
[presentation on the topic](https://mesonet.agron.iastate.edu/present/130903_isu/isumet_fall2013_web.pdf) by
Daryl Herzmann from Iowa State. I think the phrase "down the rabbit
hole" occurs to everyone who looks into this topic.


## Official NOAA Daily Precipitation Totals

Official historical daily precipitation data, by weather station, is
available from the National Oceanic and Atmospheric Administration
([NOAA](https://www.ncdc.noaa.gov/cdo-web/)). The system requires you
to submit a request after which they email you a link. It is clunky
but fairly quick.

```{r, echo=FALSE}
setwd('~/git/rmcd/daily_precipitation_totals')
yr = 2017; mth = 5;
#lgahist = read_csv('data/lga_daily_2013.csv')
lgahist = read_csv('data/lga_daily_2017.csv')
lga = lgahist %>% 
  select(DATE, Historical=PRCP) %>% 
  mutate(year=as.numeric(substr(DATE, 1, 4)), 
         month=as.numeric(substr(DATE, 5, 6)), 
         day=as.numeric(substr(DATE, 7, 8))) %>% 
  filter(year==yr, month==mth)

```

## Computing LGA precipitation totals from ASOS data 

The ASOS data was obtained from [Iowa
State](https://mesonet.agron.iastate.edu/request/download.phtml?network=NY_ASOS)
by selecting the New York ASOS and then LGA.

<!-- https://mesonet.agron.iastate.edu/cgi-bin/request/asos.py?station=LGA&data=all&year1=2013&month1=5&day1=30&year2=2013&month2=8&day2=1&tz=Etc%2FUTC&format=comma&latlon=no&direct=no&report_type=1&report_type=2 -->

There are several important things to realize when using the ASOS data.

1. The reported precipitation number is cumulative for an hour, up
to a reset time which is typically between 51 and 57 minutes (thank
you Daryl!) So the hourly total is this final value before the
reset.

2. The reported daily total (available from the NOAA site above and
widely reported as the official number) is the sum of the hourly
values, where a day is defined as midnight to midnight, local
*standard* time. Daylight savings time (DST) is not
observed for this purpose. Ignoring DST makes sense, as the days on
which DST is adopted and removed would otherwise create either an
hour hole or a double-counted hour.

3. Absence of precipitation may be reported as an "M" rather than 0.
I code this as `NA`.

4. Beginning in 2017, there is generally a record every 5 minutes,
plus a record for the precipitation reset minute. Prior to 2017,
there was most commonly only a record for the reset minute.

The reset minute can vary by site. It is obvious by inspection that
the LGA reset occurs at 51 minutes, but this is not true for all
ASOS. So in the code below I compute the value of `modalminute`. I
do this by finding, for each hour, the minute in the data at which
maximum precipitation is recorded. The `which.max` function will
pick out the row with the maximum precipitation if there is a unique
maximum, otherwise it will pick ou the first row reporting the
maximum value. Because there is a preponderance of zeros, this
algorithm will select the wrong reset minute *unless* the data is
sorted in descending order by minute.^[For example, if sorted in
ascending order by minute, then in an hour with no rain, the 5
minute record will be the maximum value because it is the first
zero.] R has no function for computing the mode, so I use the 
`tabulate` function and `which.max` to find the most common value 
for minute. I assume that this is the reset time.

I specify the time zone as "America/New_York" and
then undo DST by using the `dst` function to see if daylight savings
time is in effect, and then if so, subtracting 3600 seconds from the
time.

If you are fascinated by the issues involved in measuring
precipitation,
[be sure to take a look at this presentation.](https://mesonet.agron.iastate.edu/present/130903_isu/isumet_fall2013_web.pdf)


```{r}
## This was inspired by Hadley Wickham's 
## weather.r in the R package nycflights13
#x = read_csv('data/asos_lga_2013-06-01_2013-08-01.csv'
x = read_csv('data/asos_lga_2017-03-31_2017-06-02.csv',
             skip=5, na='M')
x$p01i[is.na(x$p01i)] = 0
precip = x %>% 
  select(station, valid, p01i) %>% 
  mutate(date = with_tz(as.POSIXct(valid, tz='UCT'),
                       "America/New_York"),
         date = date-dst(date)*3600,
         year = year(date),
         month = month(date),
         day = day(date),
         hour = hour(date),
         minute = minute(date)) %>% 
  group_by(year, month, day, hour) 

modalminute = precip %>%
  filter(p01i > 0) %>% 
  arrange(desc(minute), .by_group=TRUE) %>% 
  mutate(maxminute = minute[which.max(p01i)]) %>% 
  {which.max(tabulate(.$maxminute))}

precip =  precip %>% 
  filter(minute <= modalminute) %>% 
  summarize(hourlyprecip = max(p01i, na.rm=TRUE)) %>% 
  group_by(year, month, day) %>% 
  summarize('Daily Precipitation (ASOS)' = 
              sum(hourlyprecip, na.rm=TRUE)) %>% 
  filter(year==yr, month==mth) %>% 
  left_join(lga %>% select(Historical:day))
  
```

  
## Comparison of NOAA and ASOS daily precipitation totals

You can see in the table below that the ASOS totals, computed above,
almost exactly match the NOAA daily precipitation totals.  On two 
days, the ASOS totals is less than the NOAA total by 0.01", and this
difference is corrected the next day. I am not sure why this
happens.

  
```{r, echo=FALSE}
kable(precip,
      caption = paste0('24-hour precipitation. ',
                         'Hourly cumulation reset at ', 
                         modalminute, ' minutes'))
  
```

